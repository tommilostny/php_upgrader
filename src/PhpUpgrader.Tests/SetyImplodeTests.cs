namespace PhpUpgrader.Tests;

public class SetyImplodeTests : UnitTestWithOutputBase
{
    public SetyImplodeTests(ITestOutputHelper output) : base(output)
    {
    }

    [Fact]
    public void ChangesImplodesInInsert()
    {
        //Arrange
        var file = new FileWrapper("sety_form.php", "if ($_POST['trouba']) {\r\n\t\t\t$sets .= \"Trouby: \".implode(\", \",$_POST['trouba']).\"<br />\";\r\n\t\t}\r\n\t\tif ($_POST['v_desky']) {\r\n\t\t\t$sets .= \"Varné desky: \".implode(\", \",$_POST['v_desky']).\"<br />\";\r\n\t\t}\r\n\t\tif ($_POST['m_touby_b']) {\r\n\t\t\t$sets .= \"Mirovlnné trouby vestavné: \".implode(\", \",$_POST['m_touby_b']).\"<br />\";\r\n\t\t}\r\n\t\tif ($_POST['m_touby_f']) {\r\n\t\t\t$sets .= \"Mirovlnné trouby volně stojící: \".implode(\", \",$_POST['m_touby_f']).\"<br />\";\r\n\t\t}\r\n\t\tif ($_POST['pracky_b']) {\r\n\t\t\t$sets .= \"Pračky vestavné: \".implode(\", \",$_POST['pracky_b']).\"<br />\";\r\n\t\t}\r\n\t\tif ($_POST['pracky_f']) {\r\n\t\t\t$sets .= \"Pračky volně stojící: \".implode(\", \",$_POST['pracky_f']).\"<br />\";\r\n\t\t}\r\n\t\tif ($_POST['kavovary_b']) {\r\n\t\t\t$sets .= \"Kávovary vestavné: \".implode(\", \",$_POST['kavovary_b']).\"<br />\";\r\n\t\t}\r\n\t\tif ($_POST['kavovary_f']) {\r\n\t\t\t$sets .= \"Kávovary volně stojící: \".implode(\", \",$_POST['kavovary_f']).\"<br />\";\r\n\t\t}\r\n\t\tif ($_POST['vinoteky']) {\r\n\t\t\t$sets .= \"Vinotéky: \".implode(\", \",$_POST['vinoteky']).\"<br />\";\r\n\t\t}\r\n\t\tif ($_POST['mycky_b']) {\r\n\t\t\t$sets .= \"Myčky vestavné: \".implode(\", \",$_POST['mycky_b']).\"<br />\";\r\n\t\t}\r\n\t\tif ($_POST['mycky_f']) {\r\n\t\t\t$sets .= \"Myčky volně stojící: \".implode(\", \",$_POST['mycky_f']).\"<br />\";\r\n\t\t}\r\n\t\tif ($_POST['chlazeni_b']) {\r\n\t\t\t$sets .= \"Chlazení vestavné: \".implode(\", \",$_POST['chlazeni_b']).\"<br />\";\r\n\t\t}\r\n\t\tif ($_POST['chlazeni_f']) {\r\n\t\t\t$sets .= \"Chlazení volně stojící: \".implode(\", \",$_POST['chlazeni_f']).\"<br />\";\r\n\t\t}\r\n\t\tif ($_POST['odsavac']) {\r\n\t\t\t$sets .= \"Odsavače: \".implode(\", \",$_POST['odsavac']).\"<br />\";\r\n\t\t}\r\n\t\tif ($_POST['baterie']) {\r\n\t\t\t$sets .= \"Baterie: \".implode(\", \",$_POST['baterie']).\"<br />\";\r\n\t\t}\r\n\t\tif ($_POST['drez']) {\r\n\t\t\t$sets .= \"Dřezy: \".implode(\", \",$_POST['drez']).\"<br />\";\r\n\t\t}\r\n\t\tif ($_POST['znacka']) {\r\n\t\t\t$sets .= \"Vybrané značky: \".implode(\", \",$_POST['znacka']).\"<br />\";\r\n\t\t}\r\n\t\tif ($_POST['spotrebice'] != \"\") {\r\n\t\t\t$sets .= \"Vybrané spotřebiče: \".nl2br($_POST['spotrebice']).\"<br />\";\r\n\t\t}\r\n\t\tif ($_POST['barva']) {\r\n\t\t\t$sets .= \"Vybrané barevné provedení: \".implode(\", \",$_POST['barva']).\"<br />\";\r\n\t\t}\r\n\t\tif ($_POST['design'] == \"ano\") {\r\n\t\t\t$sets .= \"Set designově sladit!<br />\";\r\n\t\t}\r\n\t\telseif ($_POST['design'] == \"ne\") {\r\n\t\t\t$sets .= \"Set nemusí být deignově sladěn.<br />\";\r\n\t\t}\r\n\t\t\r\n\t\t$sets .= \"Cenové rozpětí za set: \".number_format($_POST['from'], 0, ',', ' ').\" - \".number_format($_POST['to'], 0, ',', ' ').\" Kč<br /><br />\";\t\r\n\t\tif (count($_POST['obsluha'] > 0)) {\r\n\t\t\t$sets .= \"Vybraný specialista: \".implode(\", \",$_POST['obsluha']).\"<br />\";\r\n\t\t}\r\n\t\tif ($_POST['poznamka'] != \"\") {\r\n\t\t\t$sets .= \"Poznámka: \".nl2br($_POST['poznamka']).\"<br />\";\r\n\t\t}\r\n\t\t\r\n\t\t/*$pom_tel = explode(\",\", $_POST['telefon']);\r\n\t\t$jmeno = trim($pom_tel[0]);\r\n\t\tif ($pom_tel[1]) {\r\n\t\t\t$telefon = trim(str_replace(\" \", \"\",$pom_tel[1]));\r\n\t\t\t$telefon = substr($telefon, -9);\r\n\t\t} else {\r\n\t\t\t$telefon = 0;\r\n\t\t}*/\r\n\t\t\r\n\t\t// klientovi //\r\n        $telo_klient  = \"<html><body>\";\r\n\t\t$telo_klient .= \"Děkujeme za Vaši poptávku,<br /><br />\";\r\n        $telo_klient .= \"poptáváte následující prvky do setu:<br />\";\r\n\t\t$telo_klient .= $sets;\r\n        $telo_klient .= \"<br />Přejeme krásný den.<br />\";\r\n        $telo_klient .= $vypis_table_nastaveni[\"domena\"];\r\n\t\t$telo_klient .= \"</body></html>\";\r\n\r\n        // firme //\r\n        $telo_firma  = \"<html><body>\";\r\n\t\t$telo_firma .= \"Klient poptává následující prvky do setu:<br />\";\r\n\t\t$telo_firma .= $sets;\r\n        $telo_firma .= \"Jméno: \".$jmeno.\"<br />\";\r\n\t\t$telo_firma .= \"E-mail: \".$_POST['mail'].\"<br />\";\r\n        $telo_firma .= \"Telefon: \".number_format($telefon,0 , \",\", \" \").\"<br />\";\r\n\t\t$telo_firma .= \"Detail objednávky: <a href=\\\"http://www.vestavne-spotrebice.cz/aegisx/a_load.php?menu=obj_sety_detail&id=\".$obj_id.\"\\\">detail</a>\";\r\n\t\t$telo_firma .= \"</body></html>\";\r\n\r\n        //$to, $from_user, $from_email, $subject = '(No subject)', $message = ''\r\n\t\tif(@mail_utf8($to_klient, 'Vestavné spotřebiče', $from_k, $subject_k, $telo_klient))\r\n          {\r\n            @mail_utf8($to_firma, $from_f, $from_f, $subject_f, $telo_firma);\r\n            echo \"<span class='text3'>Děkujeme. Vaše poptávka byla přijata ke zpracování.</span><br />\";\r\n\r\n\t\t\t//Google Code for odesl&aacute;n&iacute; formul&aacute;&#345;e Conversion Page\r\n\t\t\t?>\r\n\t\t\t<script type=\"text/javascript\">\r\n\t\t\t/* <![CDATA[ */\r\n\t\t\tvar google_conversion_id = 1031245727;\r\n\t\t\tvar google_conversion_language = \"en\";\r\n\t\t\tvar google_conversion_format = \"3\";\r\n\t\t\tvar google_conversion_color = \"ffffff\";\r\n\t\t\tvar google_conversion_label = \"SrQaCK6a0F4Qn5_e6wM\";\r\n\t\t\tvar google_remarketing_only = false;\r\n\t\t\t/* ]]> */\r\n\t\t\t</script>\r\n\t\t\t<script type=\"text/javascript\" src=\"//www.googleadservices.com/pagead/conversion.js\">\r\n\t\t\t</script>\r\n\t\t\t<noscript>\r\n\t\t\t<div style=\"display:inline;\">\r\n\t\t\t<img height=\"1\" width=\"1\" style=\"border-style:none;\" alt=\"\" src=\"//www.googleadservices.com/pagead/conversion/1031245727/?label=SrQaCK6a0F4Qn5_e6wM&amp;guid=ON&amp;script=0\"/>\r\n\t\t\t</div>\r\n\t\t\t</noscript>\r\n            <?php /* sklik */?>\r\n\t\t\t<iframe width=\"119\" height=\"22\" frameborder=\"0\" scrolling=\"no\" src=\"//c.imedia.cz/checkConversion?c=100013727&color=ffffff&v=1\"></iframe>\r\n            <?php\t\t\r\n\t\t\t//var_dump($_POST);\r\n\t\t\t// vlozeni do DB\r\n\t\t\t\r\n\t\t\t$datum = strtotime(\"now\");\r\n\t\t\t$_POST['from'] = str_replace(\",\",\".\", nl2br($_POST['from']));\r\n\t\t\t$cena_od_tmp = explode(\".\",$_POST['from']);\r\n\t\t\t$cena_od = $cena_od_tmp[0];\r\n\t\t\t$_POST['to'] = str_replace(\",\",\".\", nl2br($_POST['to']));\r\n\t\t\t$cena_do_tmp = explode(\".\",$_POST['to']);\r\n\t\t\t$cena_do = $cena_do_tmp[0];\r\n\t\t\t$ins_query = \"INSERT INTO demand_sets VALUES (\".$obj_id.\", '\".$_POST['mail'].\"', '\".$telefon.\"', '\".implode(\", \",$_POST['trouba']).\"', '\".implode(\", \",$_POST['v_desky']).\"', '\".implode(\", \",$_POST['m_touby_b']).\"', '\".implode(\", \",$_POST['m_touby_f']).\"', '\".implode(\", \",$_POST['pracky_b']).\"', '\".implode(\", \",$_POST['pracky_f']).\"', '\".implode(\", \",$_POST['kavovary_b']).\"', '\".implode(\", \",$_POST['kavovary_f']).\"', '\".implode(\", \",$_POST['vinoteky']).\"', '\".implode(\", \",$_POST['mycky_b']).\"', '\".implode(\", \",$_POST['mycky_f']).\"', '\".implode(\", \",$_POST['chlazeni_b']).\"', '\".implode(\", \",$_POST['chlazeni_f']).\"', '\".implode(\", \",$_POST['odsavac']).\"', '\".implode(\", \",$_POST['baterie']).\"', '\".implode(\", \",$_POST['drez']).\"', '\".implode(\", \",$_POST['znacka']).\"', '\".implode(\", \",$_POST['obsluha']).\"', '\".$cena_od.\"', '\".$cena_do.\"', '\".$_POST['design'].\"', '\".implode(\", \",$_POST['barva']).\"', '\".nl2br($_POST['spotrebice']).\"', '\".nl2br($_POST['poznamka']).\"', '\".$jmeno.\"', '\".$datum.\"', NULL, '\".$_POST['pristup'].\"')\";\r\n\t\t\t$result = pg_query($ins_query);\r\n          \tif ($_POST['ukaz_sql'] == 1) {\r\n\t\t\t\techo $ins_query;\r\n\t\t\t}\r\n\t\t  }\r\n        else\r\n          {\r\n            echo \"<span class='text3 cervene'><span class='form_false'>Chyba odeslani e-mailu !</span></span><br />\";\r\n            echo \" <a href='javascript:history.go(-1);'><span class='tl_form_zpet_def'>zpět do formuláře</span></a>\";\r\n            echo \" <div class='spacer'></div>\";\r\n          } \r\n      }\r\n    else\r\n      {\r\n        echo \"<p class='text3 cervene'>Formulář není správně vyplněn !</p>\";\r\n        echo \" <a href='javascript:history.go(-1);'><span class='tl_form_zpet_def'>zpět do formuláře</span></a>\";\r\n        echo \" <div class='spacer'></div>\";\r\n      }");

        //Act
        file.UpgradeSetyFormImplodes();

        //Assert
        var updated = file.Content.ToString();
        _output.WriteLine(updated);
        Assert.True(file.IsModified);
    }
}
